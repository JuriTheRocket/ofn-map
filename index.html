<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Organisation of Free Nations</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --line:#d7deef;
      --line2:#c9d2ea;
      --text:#0f1b3a;
      --muted:#51607f;

      --member:#1b3fbf;
      --founding:#ffcc33;
      --observer:#f2994a;
      --invite:#18a999;
      --conflict:#e23b3b;
      --neutral:#9bb0cf;

      --shadow: 0 10px 26px rgba(15,27,58,.12);
      --shadow2: 0 6px 16px rgba(15,27,58,.10);
      --r:18px;
      --r2:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text); background:linear-gradient(180deg,#fff,var(--bg)); overflow:hidden; }

    #map{ position:fixed; inset:0; z-index:1; }

    #topbar{
      position:fixed; z-index:30;
      left:16px; right:16px; top:14px;
      min-height:60px;
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      background:rgba(255,255,255,.90);
      border:1px solid var(--line);
      border-radius:var(--r2);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      opacity:0;
      transform: translateY(-6px);
      pointer-events:none;
      transition: opacity .28s ease, transform .28s ease;
    }
    #topbar.ready{
      opacity:1; transform: translateY(0);
      pointer-events:auto;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:260px; }
    .emblem{
      width:38px; height:38px; border-radius:14px;
      border:1px solid var(--line);
      background: radial-gradient(circle at 35% 30%, rgba(43,109,255,.35), rgba(27,63,191,.10) 55%, rgba(255,255,255,1) 100%);
      box-shadow: 0 0 0 6px rgba(27,63,191,.06);
      position:relative; overflow:hidden;
      flex:0 0 auto;
    }
    .emblem:after{
      content:"";
      position:absolute; inset:-35%;
      background: conic-gradient(from 200deg, rgba(255,204,51,.0) 0 20%, rgba(255,204,51,.35) 20% 26%, rgba(255,204,51,0) 26% 55%, rgba(43,109,255,.22) 55% 62%, rgba(255,204,51,0) 62% 100%);
      animation: spin 10s linear infinite;
      opacity:.9;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .brand h1{ margin:0; font-size:13px; letter-spacing:.18em; text-transform:uppercase; color:var(--member); }
    .brand .sub{ margin:2px 0 0 0; font-size:12px; color:var(--muted); }

    .controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    input, select, button{
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:9px 12px;
      outline:none;
      box-shadow:0 0 0 0 rgba(43,109,255,0);
      transition: box-shadow .16s ease, border-color .16s ease, transform .10s ease;
    }
    input{ min-width: 220px; }
    input::placeholder{ color: rgba(81,96,127,.65); }
    button{ cursor:pointer; background: linear-gradient(180deg,#fff,#f7f9ff); }
    button:hover{ border-color: var(--line2); box-shadow: 0 0 0 4px rgba(43,109,255,.10); }
    button:active{ transform: translateY(1px); }
    .primary{
      border-color: rgba(27,63,191,.25);
      background: linear-gradient(180deg, rgba(43,109,255,.12), rgba(27,63,191,.06));
    }

    #statusline{
      position:fixed; z-index:25;
      left:16px; bottom:16px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      display:flex; gap:10px; align-items:center;
      color:var(--muted);
      max-width: calc(100vw - 32px);
      opacity:0;
      transform: translateY(6px);
      pointer-events:none;
      transition: opacity .28s ease, transform .28s ease;
    }
    #statusline.ready{ opacity:1; transform: translateY(0); pointer-events:auto; }
    .pillDot{ width:9px; height:9px; border-radius:50%; background:var(--member); box-shadow: 0 0 0 4px rgba(43,109,255,.12); }
    #statusline b{ color:var(--text); }

    #drawer{
      position:fixed; z-index:35;
      top:88px; left:16px; bottom:16px;
      width:min(440px, calc(100vw - 32px));
      background:rgba(255,255,255,.94);
      border:1px solid var(--line);
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      transform: translateX(-112%);
      transition: transform .22s ease;
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    #drawer.open{ transform: translateX(0); }

    .drawerHead{
      padding:14px 14px 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg,#fff, rgba(247,249,255,.85));
    }
    .drawerTitle{ display:flex; align-items:center; gap:10px; min-width:0; }
    .flagBig{
      width:44px; height:44px; border-radius:16px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:0 0 0 6px rgba(27,63,191,.06);
      font-size:22px;
      flex:0 0 auto;
    }
    .titleText{ min-width:0; }
    .titleText h2{ margin:0; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .titleText .mini{ margin-top:2px; font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .badge{
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
    }
    .badge.member{ border-color: rgba(43,109,255,.40); color:#1033a3; }
    .badge.founding{ border-color: rgba(255,204,51,.60); color:#7c5b00; }
    .badge.observer{ border-color: rgba(242,153,74,.55); color:#7b3f00; }
    .badge.invite{ border-color: rgba(24,169,153,.55); color:#0b5b51; }
    .badge.conflict{ border-color: rgba(226,59,59,.55); color:#7b1414; }
    .badge.neutral{ border-color: rgba(155,176,207,.60); color:#3a4c6c; }

    .drawerActions{ display:flex; gap:8px; align-items:center; }
    .iconBtn{
      width:38px; height:38px; border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      display:grid; place-items:center;
    }
    .iconBtn:hover{ box-shadow: 0 0 0 4px rgba(43,109,255,.10); }

    .drawerBody{
      padding:12px 14px 14px 14px;
      overflow:auto;
      display:flex; flex-direction:column; gap:10px;
      min-height:0;
    }
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:#fff;
      box-shadow: 0 6px 14px rgba(15,27,58,.06);
      padding:12px;
    }
    .card h3{
      margin:0 0 8px 0;
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .kv{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background: linear-gradient(180deg,#fff,#fbfcff);
    }
    .kv .k{
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .kv .v{ margin-top:4px; font-weight:650; color:var(--text); overflow-wrap:anywhere; }
    .note{ margin:0; color:var(--muted); }
    .link{ color: var(--member); text-decoration: none; border-bottom: 1px dotted rgba(27,63,191,.35); }
    .link:hover{ border-bottom-color: rgba(27,63,191,.75); }

    #intro{
      position:fixed; inset:0; z-index:60;
      background:#ffffff;
      display:grid; place-items:center;
      transition: opacity .28s ease;
    }
    #intro.hidden{ opacity:0; pointer-events:none; }
    #introCanvas{
      width:min(760px, calc(100vw - 36px));
      height:360px;
      display:block;
    }

    .leaflet-control-attribution{
      background: rgba(255,255,255,.90) !important;
      border: 1px solid var(--line) !important;
      border-radius: 12px !important;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      color: var(--muted) !important;
    }
    .leaflet-control-zoom a{
      background: rgba(255,255,255,.92) !important;
      border: 1px solid var(--line) !important;
      color: var(--text) !important;
    }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip{
      background: rgba(255,255,255,.96) !important;
      border: 1px solid var(--line) !important;
      box-shadow: var(--shadow2);
      color: var(--text) !important;
      backdrop-filter: blur(10px);
    }

    @media (max-width: 720px){
      #topbar{ left:12px; right:12px; }
      #statusline{ left:12px; right:12px; max-width: calc(100vw - 24px); }
      #drawer{ left:12px; width: calc(100vw - 24px); }
      input{ min-width: 160px; }
      .grid2{ grid-template-columns:1fr; }
      #introCanvas{ height:300px; }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="topbar" role="banner">
    <div class="brand">
      <div class="emblem" aria-hidden="true"></div>
      <div>
        <h1>Organisation of Free Nations</h1>
        <div class="sub">Click any country to view real-world info</div>
      </div>
    </div>

    <div class="controls" role="toolbar" aria-label="Controls">
      <input id="search" type="text" placeholder="Search any country‚Ä¶" spellcheck="false" />
      <select id="filter">
        <option value="all">All statuses</option>
        <option value="member">Member</option>
        <option value="founding">Founding</option>
        <option value="observer">Observer</option>
        <option value="invite">Open invite</option>
        <option value="conflict">Conflict</option>
        <option value="neutral">Neutral</option>
      </select>
      <button id="fitBtn" type="button">Fit</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <div id="statusline" aria-live="polite">
    <span class="pillDot"></span>
    <span><b id="selName">No selection</b> ¬∑ <span id="selStatus">‚Äî</span></span>
  </div>

  <aside id="drawer" aria-label="Country details panel">
    <div class="drawerHead">
      <div class="drawerTitle">
        <div class="flagBig" id="dFlag">üåç</div>
        <div class="titleText">
          <h2 id="dName">‚Äî</h2>
          <div class="mini">
            <span class="badge neutral" id="dBadge">‚Äî</span>
            <span id="dMini">‚Äî</span>
          </div>
        </div>
      </div>
      <div class="drawerActions">
        <button class="iconBtn" id="zoomBtn" type="button" title="Zoom to country">‚§¢</button>
        <button class="iconBtn" id="closeBtn" type="button" title="Close">‚úï</button>
      </div>
    </div>
    <div class="drawerBody" id="drawerBody"></div>
  </aside>

  <section id="intro" aria-label="Loading">
    <canvas id="introCanvas"></canvas>
  </section>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const OFN = {
      members: new Set(["Luxembourg","Falkland Islands","Israel","United States of America","Philippines","Brazil"]),
      founding: new Set(["Falkland Islands"]),
      observer: new Set(["China"]),
      invite: new Set(["Japan"]),
      conflict: new Set(["Germany"]),
      hq: "Luxembourg"
    };

    const NAME_ALIASES = new Map([
      ["United States", "United States of America"],
      ["USA", "United States of America"],
      ["Russian Federation", "Russia"],
      ["Czechia", "Czech Republic"]
    ]);

    function canonicalName(name){
      const n = (name || "").trim();
      return NAME_ALIASES.get(n) || n;
    }

    function statusOf(name){
      const n = canonicalName(name);
      if (OFN.founding.has(n)) return "founding";
      if (OFN.members.has(n)) return "member";
      if (OFN.observer.has(n)) return "observer";
      if (OFN.invite.has(n)) return "invite";
      if (OFN.conflict.has(n)) return "conflict";
      return "neutral";
    }

    function statusLabel(s){
      return ({
        founding:"Founding nation",
        member:"Member nation",
        observer:"Observer state",
        invite:"Open invite",
        conflict:"Conflict",
        neutral:"Neutral"
      }[s] || "Neutral");
    }

    function statusColor(s){
      const css = getComputedStyle(document.documentElement);
      return ({
        member: css.getPropertyValue("--member").trim(),
        founding: css.getPropertyValue("--founding").trim(),
        observer: css.getPropertyValue("--observer").trim(),
        invite: css.getPropertyValue("--invite").trim(),
        conflict: css.getPropertyValue("--conflict").trim(),
        neutral: css.getPropertyValue("--neutral").trim()
      }[s] || css.getPropertyValue("--neutral").trim());
    }

    function badgeClass(s){
      return ({
        member:"member",
        founding:"founding",
        observer:"observer",
        invite:"invite",
        conflict:"conflict",
        neutral:"neutral"
      }[s] || "neutral");
    }

    const el = (id) => document.getElementById(id);
    const escapeHTML = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    const normalize = (s) => (s||"").toLowerCase().replace(/\s+/g," ").trim();

    let map, countriesLayer;
    let selectedFeature = null;
    let selectedName = null;

    const topbar = el("topbar");
    const statusline = el("statusline");
    const drawer = el("drawer");
    const drawerBody = el("drawerBody");

    function setStatusLine(name){
      if (!name){
        el("selName").textContent = "No selection";
        el("selStatus").textContent = "‚Äî";
        return;
      }
      const s = statusOf(name);
      el("selName").textContent = name;
      el("selStatus").textContent = statusLabel(s);
    }

    function openDrawer(){ drawer.classList.add("open"); }
    function closeDrawer(){ drawer.classList.remove("open"); }

    function setDrawerHeader(name){
      const s = statusOf(name);
      el("dName").textContent = name;
      el("dMini").textContent = (name === OFN.hq) ? "Headquarters" : "‚Äî";
      el("dFlag").textContent = "üåç";

      const b = el("dBadge");
      b.className = `badge ${badgeClass(s)}`;
      b.textContent = statusLabel(s);
    }

    async function fetchWikiSummary(title){
      const t = encodeURIComponent(title.replace(/\s+/g, "_"));
      const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${t}`;
      const res = await fetch(url, { headers: { "accept":"application/json" } });
      if (!res.ok) throw new Error("wiki");
      return await res.json();
    }

    async function fillDrawerFromInternet(name){
      setDrawerHeader(name);

      const s = statusOf(name);
      const cards = [];

      cards.push(`
        <div class="card">
          <h3>Status</h3>
          <div class="grid2">
            <div class="kv"><div class="k">OFN</div><div class="v">${escapeHTML(statusLabel(s))}</div></div>
            <div class="kv"><div class="k">Designation</div><div class="v">${escapeHTML((name===OFN.hq) ? "Headquarters" : "‚Äî")}</div></div>
          </div>
        </div>
      `);

      let wiki = null;
      let wikiTitle = name;

      try{
        wiki = await fetchWikiSummary(wikiTitle);
      }catch(e){
        if (name === "Falkland Islands"){
          try{ wiki = await fetchWikiSummary("Falkland Islands"); }catch(_){}
        }
        if (!wiki && name === "United States of America"){
          try{ wiki = await fetchWikiSummary("United States"); wikiTitle = "United States"; }catch(_){}
        }
        if (!wiki && name === "Philippines"){
          try{ wiki = await fetchWikiSummary("Philippines"); }catch(_){}
        }
      }

      if (wiki && (wiki.extract || wiki.description)){
        const extract = wiki.extract ? escapeHTML(wiki.extract) : "";
        const desc = wiki.description ? escapeHTML(wiki.description) : "";
        const page = wiki.content_urls && wiki.content_urls.desktop && wiki.content_urls.desktop.page ? wiki.content_urls.desktop.page : null;

        cards.push(`
          <div class="card">
            <h3>Overview</h3>
            <p class="note" style="margin:0 0 10px 0;">${desc || ""}</p>
            <p class="note" style="margin:0;">${extract || "‚Äî"}</p>
            ${page ? `<p style="margin:10px 0 0 0;"><a class="link" href="${page}" target="_blank" rel="noopener noreferrer">Open source</a></p>` : ""}
          </div>
        `);

        const fields = [];
        if (wiki.titles && wiki.titles.display) fields.push(["Article", wiki.titles.display]);
        if (wiki.lang) fields.push(["Language", wiki.lang]);
        if (wiki.type) fields.push(["Type", wiki.type]);

        if (fields.length){
          cards.push(`
            <div class="card">
              <h3>Source metadata</h3>
              <div class="grid2">
                ${fields.map(([k,v]) => `<div class="kv"><div class="k">${escapeHTML(k)}</div><div class="v">${escapeHTML(v)}</div></div>`).join("")}
              </div>
            </div>
          `);
        }
      } else {
        cards.push(`
          <div class="card">
            <h3>Overview</h3>
            <p class="note" style="margin:0;">Could not load external summary for this country right now.</p>
          </div>
        `);
      }

      drawerBody.innerHTML = cards.join("");
    }

    function styleFeature(feature){
      const name = canonicalName(feature.properties?.name || "");
      const s = statusOf(name);
      const color = statusColor(s);

      const base = {
        color: "rgba(15,27,58,.18)",
        weight: 1,
        fillColor: color,
        fillOpacity: 0.40
      };

      if (s === "member" || s === "founding") base.fillOpacity = 0.55;
      if (s === "observer") base.fillOpacity = 0.45;
      if (s === "invite") base.fillOpacity = 0.45;
      if (s === "conflict") base.fillOpacity = 0.50;

      const currentFilter = el("filter").value;
      const matches = (currentFilter === "all") ? true : (s === currentFilter);

      if (!matches){
        base.fillOpacity = Math.min(base.fillOpacity, 0.12);
        base.opacity = 0.15;
      } else {
        base.opacity = 0.6;
      }

      return base;
    }

    function setFeatureHover(layer, on){
      const name = canonicalName(layer.feature.properties?.name || "");
      const s = statusOf(name);
      const color = statusColor(s);

      if (on){
        layer.setStyle({
          weight: 2,
          color: "rgba(27,63,191,.35)",
          fillOpacity: Math.min(0.72, (s === "member" || s === "founding") ? 0.68 : 0.58)
        });
      } else {
        layer.setStyle(styleFeature(layer.feature));
      }
    }

    function selectLayer(layer){
      if (selectedFeature && selectedFeature !== layer){
        selectedFeature.setStyle(styleFeature(selectedFeature.feature));
      }
      selectedFeature = layer;

      const name = canonicalName(layer.feature.properties?.name || "");
      selectedName = name;

      layer.setStyle({
        weight: 2.5,
        color: "rgba(27,63,191,.55)",
        fillOpacity: 0.78
      });

      setStatusLine(name);
      openDrawer();
      fillDrawerFromInternet(name).catch(() => {
        setDrawerHeader(name);
        drawerBody.innerHTML = `<div class="card"><h3>Overview</h3><p class="note" style="margin:0;">Could not load external summary right now.</p></div>`;
      });
    }

    function zoomToSelected(){
      if (!selectedFeature) return;
      try{
        map.fitBounds(selectedFeature.getBounds().pad(0.25));
      }catch(_){}
    }

    function refilter(){
      if (!countriesLayer) return;
      countriesLayer.eachLayer((layer) => {
        layer.setStyle(styleFeature(layer.feature));
      });
      if (selectedFeature){
        selectedFeature.setStyle({
          weight: 2.5,
          color: "rgba(27,63,191,.55)",
          fillOpacity: 0.78
        });
      }
    }

    function findCountryLayerByName(query){
      const q = normalize(canonicalName(query));
      if (!q || !countriesLayer) return null;

      let best = null;
      countriesLayer.eachLayer((layer) => {
        const name = normalize(canonicalName(layer.feature.properties?.name || ""));
        if (name === q) best = layer;
      });
      if (best) return best;

      let partial = null;
      countriesLayer.eachLayer((layer) => {
        const name = normalize(canonicalName(layer.feature.properties?.name || ""));
        if (!partial && name.includes(q)) partial = layer;
      });
      return partial;
    }

    function initMap(){
      map = L.map("map", {
        zoomControl: false,
        worldCopyJump: true,
        preferCanvas: true
      }).setView([22, 0], 2);

      L.control.zoom({ position: "bottomright" }).addTo(map);

      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        subdomains: "abcd",
        maxZoom: 7,
        minZoom: 2,
        attribution: "&copy; OpenStreetMap contributors &copy; CARTO"
      }).addTo(map);

      const geoUrl = "https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson";

      fetch(geoUrl)
        .then(r => r.json())
        .then(geo => {
          countriesLayer = L.geoJSON(geo, {
            style: styleFeature,
            onEachFeature: (feature, layer) => {
              layer.on("mouseover", () => setFeatureHover(layer, true));
              layer.on("mouseout", () => setFeatureHover(layer, false));
              layer.on("click", () => selectLayer(layer));
            }
          }).addTo(map);

          const bounds = countriesLayer.getBounds();
          if (bounds && bounds.isValid()) map.fitBounds(bounds.pad(0.02));

          wireUI();
          runIntroAnimation();
        })
        .catch(() => {
          wireUI();
          runIntroAnimation();
        });
    }

    function wireUI(){
      el("closeBtn").addEventListener("click", closeDrawer);
      el("zoomBtn").addEventListener("click", zoomToSelected);

      el("fitBtn").addEventListener("click", () => {
        if (countriesLayer){
          const b = countriesLayer.getBounds();
          if (b && b.isValid()) map.fitBounds(b.pad(0.02));
        }
      });

      el("resetBtn").addEventListener("click", () => {
        el("search").value = "";
        el("filter").value = "all";
        refilter();
        closeDrawer();
        selectedName = null;
        selectedFeature = null;
        setStatusLine(null);
      });

      el("filter").addEventListener("change", refilter);

      const searchEl = el("search");
      const doSearch = () => {
        const q = searchEl.value.trim();
        if (!q) return;
        const layer = findCountryLayerByName(q);
        if (layer){
          selectLayer(layer);
          try{ map.fitBounds(layer.getBounds().pad(0.25)); }catch(_){}
        }
      };
      searchEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch();
      });
      searchEl.addEventListener("input", () => {
        // no restriction: search is for any nation
      });

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeDrawer();
      });
    }

    function emojiFlagForCountry(name){
      const n = canonicalName(name);
      const mapEmoji = new Map([
        ["Luxembourg","üá±üá∫"],
        ["Falkland Islands","üá´üá∞"],
        ["Israel","üáÆüá±"],
        ["United States of America","üá∫üá∏"],
        ["Philippines","üáµüá≠"],
        ["Brazil","üáßüá∑"]
      ]);
      return mapEmoji.get(n) || "‚òÖ";
    }

    function runIntroAnimation(){
      const intro = el("intro");
      const canvas = el("introCanvas");
      const ctx = canvas.getContext("2d", { alpha: true });
      if (!ctx){
        finishIntro();
        return;
      }

      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        canvas.width = Math.floor(canvas.clientWidth * dpr);
        canvas.height = Math.floor(canvas.clientHeight * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize, { passive:true });

      const members = Array.from(OFN.members);
      const nodes = members.map((name, i) => ({
        name,
        flag: emojiFlagForCountry(name),
        phase: Math.random()*Math.PI*2
      }));

      const orbitSeconds = 2.0;
      const flySeconds = 0.7;
      const fadeInSeconds = 0.5;
      const total = orbitSeconds + flySeconds + fadeInSeconds;

      let t0 = performance.now();
      function tick(now){
        const t = (now - t0)/1000;
        const w = canvas.clientWidth;
        const h = canvas.clientHeight;

        ctx.clearRect(0,0,w,h);

        const cx = w*0.5, cy = h*0.5;
        const R = Math.min(w,h)*0.26;

        const orbitT = Math.min(1, t / orbitSeconds);
        const flyT = Math.max(0, Math.min(1, (t - orbitSeconds)/flySeconds));
        const fadeT = Math.max(0, Math.min(1, (t - orbitSeconds - flySeconds)/fadeInSeconds));

        const spin = t * 0.9;

        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0,w,h);

        ctx.strokeStyle = "rgba(27,63,191,.16)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(cx, cy, R, 0, Math.PI*2);
        ctx.stroke();

        const pulse = 0.5 + 0.5*Math.sin(t*2.2);
        ctx.fillStyle = `rgba(255,204,51,${0.18 + 0.10*pulse})`;
        ctx.beginPath();
        ctx.arc(cx, cy, 4 + 2*pulse, 0, Math.PI*2);
        ctx.fill();

        const n = Math.max(1, nodes.length);
        for (let i=0;i<nodes.length;i++){
          const node = nodes[i];
          const a = (i/n)*Math.PI*2 + spin;
          let rr = R * (1 + 0.02*Math.sin(t*2.8 + node.phase));

          let x = cx + Math.cos(a)*rr;
          let y = cy + Math.sin(a)*rr;

          let alpha = Math.min(1, 0.15 + orbitT*0.85);

          if (flyT > 0){
            const dir = (i % 2 === 0) ? 1 : -1;
            x += dir * flyT * (w*0.55);
            y += (Math.sin(a)*flyT) * (h*0.12);
            alpha *= (1 - flyT);
          }

          ctx.globalAlpha = 0.55 * alpha;
          ctx.fillStyle = "rgba(255,204,51,.22)";
          ctx.beginPath();
          ctx.arc(x, y, 16, 0, Math.PI*2);
          ctx.fill();

          ctx.globalAlpha = 1 * alpha;
          ctx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillStyle = "rgba(15,27,58,.95)";
          ctx.fillText(node.flag, x, y);

          ctx.globalAlpha = 1;
        }

        if (t < total){
          requestAnimationFrame(tick);
        } else {
          finishIntro();
        }

        topbar.classList.toggle("ready", fadeT > 0.05);
        statusline.classList.toggle("ready", fadeT > 0.20);
      }

      requestAnimationFrame(tick);

      function finishIntro(){
        intro.classList.add("hidden");
        setTimeout(() => intro.remove(), 600);
        topbar.classList.add("ready");
        statusline.classList.add("ready");
      }
    }

    initMap();
  </script>
</body>
</html>
