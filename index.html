<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFN ‚Äî European-Style Dashboard</title>

  <!-- Standalone static (no keys, no backend). Uses Leaflet + OSM tiles (no API key). -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      /* EU-ish, clean, bright */
      --bg: #f5f7fb;
      --bg2:#eef2fb;
      --card:#ffffff;
      --line:#d7deef;
      --line2:#c9d2ea;
      --text:#0f1b3a;
      --muted:#51607f;

      --blue:#1b3fbf;     /* EU-ish blue */
      --blue2:#2b6dff;
      --gold:#ffcc33;     /* EU stars */
      --teal:#18a999;
      --orange:#f2994a;
      --gray:#8aa0c2;

      --shadow: 0 10px 26px rgba(15,27,58,.12);
      --shadow2: 0 6px 16px rgba(15,27,58,.10);

      --r: 18px;
      --r2: 22px;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; margin:0; font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:linear-gradient(180deg,var(--bg),var(--bg2)); overflow:hidden; }

    /* Top bar */
    #topbar{
      position: fixed;
      z-index: 30;
      left: 16px;
      right: 16px;
      top: 14px;
      height: 60px;
      background: rgba(255,255,255,.86);
      border: 1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 14px;
      gap: 12px;
    }

    .brand{
      display:flex; align-items:center; gap: 12px; min-width: 280px;
    }
    .emblem{
      width: 38px; height: 38px; border-radius: 14px;
      border: 1px solid var(--line);
      background: radial-gradient(circle at 35% 30%, rgba(43,109,255,.35), rgba(27,63,191,.10) 55%, rgba(255,255,255,1) 100%);
      box-shadow: 0 0 0 6px rgba(27,63,191,.06);
      position:relative; overflow:hidden;
    }
    .emblem:after{
      content:"";
      position:absolute; inset:-35%;
      background: conic-gradient(from 200deg, rgba(255,204,51,.0) 0 20%, rgba(255,204,51,.35) 20% 26%, rgba(255,204,51,0) 26% 55%, rgba(43,109,255,.22) 55% 62%, rgba(255,204,51,0) 62% 100%);
      animation: spin 10s linear infinite;
      opacity:.9;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .brand h1{ margin:0; font-size: 13px; letter-spacing:.18em; text-transform:uppercase; color: var(--blue); }
    .brand .sub{ margin:2px 0 0 0; font-size: 12px; color: var(--muted); }

    .controls{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; justify-content:flex-end; }
    input, select, button{
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      padding: 9px 12px;
      outline: none;
      box-shadow: 0 0 0 0 rgba(43,109,255,0);
      transition: box-shadow .16s ease, border-color .16s ease, transform .10s ease;
    }
    input::placeholder{ color: rgba(81,96,127,.65); }
    button{ cursor:pointer; background: linear-gradient(180deg, #ffffff, #f7f9ff); }
    button:hover{ border-color: var(--line2); box-shadow: 0 0 0 4px rgba(43,109,255,.10); }
    button:active{ transform: translateY(1px); }
    .primary{
      border-color: rgba(27,63,191,.25);
      background: linear-gradient(180deg, rgba(43,109,255,.12), rgba(27,63,191,.06));
    }

    /* Map */
    #map{
      position: fixed;
      inset: 0;
      z-index: 1;
    }

    /* Light ‚ÄúEU‚Äù footer-ish badge */
    #statusline{
      position: fixed;
      z-index: 25;
      left: 16px;
      bottom: 16px;
      background: rgba(255,255,255,.88);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      display:flex;
      gap: 10px;
      align-items:center;
      color: var(--muted);
      max-width: calc(100vw - 32px);
    }
    .pillDot{
      width: 9px; height: 9px; border-radius: 50%;
      background: var(--blue2);
      box-shadow: 0 0 0 4px rgba(43,109,255,.12);
    }
    #statusline b{ color: var(--text); }

    /* Left drawer (only opens when you click a nation) */
    #drawer{
      position: fixed;
      z-index: 35;
      top: 88px;
      left: 16px;
      bottom: 16px;
      width: min(420px, calc(100vw - 32px));
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      transform: translateX(-110%);
      transition: transform .22s ease;
      overflow:hidden;
      display:flex;
      flex-direction: column;
    }
    #drawer.open{ transform: translateX(0); }

    .drawerHead{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(247,249,255,.85));
    }
    .drawerTitle{
      display:flex; align-items:center; gap: 10px; min-width:0;
    }
    .flagBig{
      width: 44px; height: 44px; border-radius: 16px;
      display:grid; place-items:center;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: 0 0 0 6px rgba(27,63,191,.06);
      font-size: 22px;
      flex: 0 0 auto;
    }
    .titleText{ min-width:0; }
    .titleText h2{ margin:0; font-size: 16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .titleText .mini{ margin-top:2px; font-size: 12px; color: var(--muted); display:flex; gap:8px; align-items:center; flex-wrap: wrap; }

    .badge{
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 12px;
      color: var(--muted);
    }
    .badge.founding{ border-color: rgba(255,204,51,.55); color: #7c5b00; }
    .badge.member{ border-color: rgba(43,109,255,.40); color: #1033a3; }
    .badge.observer{ border-color: rgba(242,153,74,.45); color: #7b3f00; }
    .badge.special{ border-color: rgba(24,169,153,.45); color: #0b5b51; }
    .badge.neutral{ border-color: rgba(138,160,194,.45); color: #3a4c6c; }

    .drawerActions{ display:flex; gap: 8px; align-items:center; }
    .iconBtn{
      width: 38px; height: 38px; border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      cursor:pointer;
      display:grid; place-items:center;
    }
    .iconBtn:hover{ box-shadow: 0 0 0 4px rgba(43,109,255,.10); }

    .drawerBody{
      padding: 12px 14px 14px 14px;
      overflow:auto;
      display:flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: #fff;
      box-shadow: 0 6px 14px rgba(15,27,58,.06);
      padding: 12px;
    }
    .card h3{
      margin:0 0 8px 0;
      font-size: 12px;
      letter-spacing:.16em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kv{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: linear-gradient(180deg, #fff, #fbfcff);
    }
    .kv .k{
      font-size: 11px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .kv .v{
      margin-top: 4px;
      font-weight: 650;
      color: var(--text);
      overflow-wrap:anywhere;
    }
    .note{
      color: var(--muted);
      margin:0;
    }

    /* Intro overlay: only the star-ring boot (no debug screen) */
    #intro{
      position: fixed;
      inset: 0;
      z-index: 60;
      display:grid;
      place-items:center;
      background: radial-gradient(900px 600px at 50% 35%, rgba(43,109,255,.18), transparent 60%),
                  linear-gradient(180deg, #ffffff 0%, #f2f6ff 45%, #eef2fb 100%);
      transition: opacity .35s ease, transform .35s ease;
    }
    #intro.hidden{
      opacity: 0;
      pointer-events:none;
      transform: translateY(-8px);
    }
    #intro .ringWrap{
      width: min(760px, calc(100vw - 36px));
      border-radius: 30px;
      background: rgba(255,255,255,.85);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 18px 18px 14px 18px;
    }
    #intro .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 12px;
    }
    #intro .row .t{
      display:flex; align-items:center; gap: 12px;
    }
    #intro .row .t h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.18em;
      text-transform: uppercase;
      color: var(--blue);
    }
    #intro .row .t .mini{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
    }
    #intro .row .meta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    #intro .canvasBox{
      height: 300px;
      border-radius: 24px;
      border: 1px solid var(--line);
      background: radial-gradient(700px 240px at 50% 30%, rgba(43,109,255,.10), transparent 60%),
                  linear-gradient(180deg, #ffffff, #f7f9ff);
      overflow:hidden;
      position: relative;
    }
    #intro canvas{ position:absolute; inset:0; width:100%; height:100%; }
    #intro .foot{
      margin-top: 12px;
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }

    /* Leaflet styling */
    .leaflet-control-attribution{
      background: rgba(255,255,255,.86) !important;
      border: 1px solid var(--line) !important;
      border-radius: 12px !important;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      color: var(--muted) !important;
    }
    .leaflet-control-zoom a{
      background: rgba(255,255,255,.92) !important;
      border: 1px solid var(--line) !important;
      color: var(--text) !important;
    }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip{
      background: rgba(255,255,255,.95) !important;
      border: 1px solid var(--line) !important;
      box-shadow: var(--shadow2);
      color: var(--text) !important;
      backdrop-filter: blur(10px);
    }

    /* Small screens */
    @media (max-width: 720px){
      #topbar{ height:auto; padding: 10px; gap: 10px; }
      .brand{ min-width: 0; }
      .controls{ width: 100%; justify-content: flex-start; }
      #drawer{ top: 96px; width: calc(100vw - 32px); }
      .grid2{ grid-template-columns: 1fr; }
      #intro .canvasBox{ height: 260px; }
    }
  </style>
</head>

<body>
  <!-- Intro: circle of stars (flags) -> fly away -> then app -->
  <section id="intro" aria-label="Boot animation">
    <div class="ringWrap">
      <div class="row">
        <div class="t">
          <div class="emblem" aria-hidden="true"></div>
          <div>
            <h2>Organisation of Free Nations</h2>
            <div class="mini">Unified member ring ‚Ä¢ standby‚Ä¶</div>
          </div>
        </div>
        <div class="meta">
          <span><b id="introCount">0</b> member stars</span>
          <span style="display:flex;align-items:center;gap:8px;">
            <span class="pillDot" style="background:var(--gold); box-shadow: 0 0 0 4px rgba(255,204,51,.18)"></span>
            EU-style theme
          </span>
        </div>
      </div>

      <div class="canvasBox">
        <canvas id="introCanvas"></canvas>
      </div>

      <div class="foot">
        <span id="introLine">Aligning constellations‚Ä¶</span>
        <button id="skipIntro" class="primary" type="button">Skip</button>
      </div>
    </div>
  </section>

  <!-- App -->
  <div id="map" aria-label="Map"></div>

  <div id="topbar" role="banner">
    <div class="brand">
      <div class="emblem" aria-hidden="true"></div>
      <div>
        <h1>Organisation of Free Nations</h1>
        <div class="sub">European-style dashboard ‚Ä¢ click any nation to open details</div>
      </div>
    </div>

    <div class="controls" role="toolbar" aria-label="Controls">
      <input id="search" type="text" placeholder="Search nations‚Ä¶" spellcheck="false" />
      <select id="filter">
        <option value="all">All statuses</option>
        <option value="founding">Founding</option>
        <option value="member">Member</option>
        <option value="observer">Observer</option>
        <option value="special">Special</option>
        <option value="neutral">Neutral</option>
      </select>
      <button id="modeBtn" type="button" title="Toggle highlight behavior">Member Highlight: ON</button>
      <button id="fitBtn" type="button">Fit</button>
    </div>
  </div>

  <div id="statusline" aria-live="polite">
    <span class="pillDot"></span>
    <span><b id="selName">No selection</b> ¬∑ <span id="selStatus">‚Äî</span></span>
  </div>

  <!-- Drawer (left) -->
  <aside id="drawer" aria-label="Country details panel">
    <div class="drawerHead">
      <div class="drawerTitle">
        <div class="flagBig" id="dFlag">üåç</div>
        <div class="titleText">
          <h2 id="dName">‚Äî</h2>
          <div class="mini">
            <span class="badge neutral" id="dBadge">‚Äî</span>
            <span id="dMini">‚Äî</span>
          </div>
        </div>
      </div>

      <div class="drawerActions">
        <button class="iconBtn" id="zoomBtn" type="button" title="Zoom to country">‚§¢</button>
        <button class="iconBtn" id="closeBtn" type="button" title="Close">‚úï</button>
      </div>
    </div>

    <div class="drawerBody" id="drawerBody">
      <!-- Filled dynamically -->
    </div>
  </aside>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /**********************************************************************
     * EDIT THIS LIST IN GITHUB
     * status: founding | member | observer | special | neutral
     * - The intro ring uses ONLY founding+member as ‚Äúmember stars‚Äù.
     * - The map allows clicking ANY country, regardless of status.
     **********************************************************************/
    const COUNTRIES = [
      {
        id: "falklands",
        name: "Falkland Islands",
        flag: "üá´üá∞",
        status: "founding",
        capital: "Stanley",
        lat: -51.7,
        lng: -57.85,
        region: "South Atlantic",
        ofnRole: "Founding State",
        alignment: "OFN Core",
        short: "Founding state of the Organisation of Free Nations.",
        details: [
          { k: "Founding date", v: "‚Äî" },
          { k: "Security posture", v: "‚Äî" },
          { k: "Notes", v: "Edit this to your canon." }
        ]
      },
      {
        id: "usa",
        name: "United States of America",
        flag: "üá∫üá∏",
        status: "member",
        capital: "Washington, D.C.",
        lat: 38.8951,
        lng: -77.0364,
        region: "North America",
        ofnRole: "Member State",
        alignment: "OFN",
        short: "Member state.",
        details: [
          { k: "Delegation", v: "‚Äî" },
          { k: "Treaty status", v: "Ratified" },
          { k: "Notes", v: "Replace with your canon." }
        ]
      },
      {
        id: "ireland",
        name: "Ireland",
        flag: "üáÆüá™",
        status: "member",
        capital: "Dublin",
        lat: 53.3498,
        lng: -6.2603,
        region: "Europe",
        ofnRole: "Member State",
        alignment: "OFN",
        short: "Member state.",
        details: [
          { k: "Delegation", v: "‚Äî" },
          { k: "Notes", v: "‚Äî" }
        ]
      },
      {
        id: "luxembourg",
        name: "Grand Duchy of Luxembourg",
        flag: "üá±üá∫",
        status: "observer",
        capital: "Luxembourg",
        lat: 49.6116,
        lng: 6.1319,
        region: "Europe",
        ofnRole: "Observer",
        alignment: "Cooperative",
        short: "Observer participation.",
        details: [
          { k: "Access", v: "Observer sessions" },
          { k: "Notes", v: "‚Äî" }
        ]
      },
      {
        id: "brazil",
        name: "Brazil",
        flag: "üáßüá∑",
        status: "neutral",
        capital: "Bras√≠lia",
        lat: -15.7939,
        lng: -47.8828,
        region: "South America",
        ofnRole: "‚Äî",
        alignment: "Non-aligned",
        short: "Neutral / non-aligned.",
        details: [
          { k: "Notes", v: "‚Äî" }
        ]
      },
      {
        id: "switzerland",
        name: "Switzerland",
        flag: "üá®üá≠",
        status: "special",
        capital: "Bern",
        lat: 46.9480,
        lng: 7.4474,
        region: "Europe",
        ofnRole: "Special Status",
        alignment: "Special",
        short: "Special status (example).",
        details: [
          { k: "Notes", v: "Use ‚Äúspecial‚Äù for your ‚Äòsomething special‚Äô category." }
        ]
      }
    ];

    /**********************************************************************
     * Utilities
     **********************************************************************/
    const el = (id) => document.getElementById(id);
    const escapeHTML = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));

    const statusLabel = (s) => ({
      founding: "Founding",
      member: "Member",
      observer: "Observer",
      special: "Special",
      neutral: "Neutral"
    }[s] || "Unknown");

    function statusColor(s){
      const css = getComputedStyle(document.documentElement);
      const blue2 = css.getPropertyValue("--blue2").trim();
      const gold = css.getPropertyValue("--gold").trim();
      const orange = css.getPropertyValue("--orange").trim();
      const teal = css.getPropertyValue("--teal").trim();
      const gray = css.getPropertyValue("--gray").trim();
      return ({
        founding: gold,
        member: blue2,
        observer: orange,
        special: teal,
        neutral: gray
      }[s] || gray);
    }

    function badgeClass(s){
      return ({
        founding: "founding",
        member: "member",
        observer: "observer",
        special: "special",
        neutral: "neutral"
      }[s] || "neutral");
    }

    /**********************************************************************
     * Map setup
     **********************************************************************/
    let map, tileLayer;
    const markersById = new Map();
    const layerGroup = L.layerGroup();

    // Member highlight behavior:
    // ON: member+founding brighter, others subdued
    // OFF: all equal
    let memberHighlight = true;

    let selectedId = null;

    function initMap(){
      map = L.map("map", {
        zoomControl: true,
        worldCopyJump: true,
        preferCanvas: true
      }).setView([22, 0], 2);

      tileLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 6,
        minZoom: 2,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      layerGroup.addTo(map);

      // markers for all countries
      for (const c of COUNTRIES){
        const base = statusColor(c.status);
        const marker = L.circleMarker([c.lat, c.lng], {
          radius: (c.status === "founding" || c.status === "special") ? 9 : 8,
          color: base,
          fillColor: base,
          weight: 2,
          opacity: 0.9,
          fillOpacity: 0.65
        });

        marker.on("click", () => selectCountry(c.id, { pan: false, openDrawer: true }));
        marker.addTo(layerGroup);
        markersById.set(c.id, marker);
      }

      // Optional subtle ‚Äúcore network‚Äù lines between founding+members (EU-ish, light)
      const core = COUNTRIES.filter(c => c.status === "member" || c.status === "founding");
      if (core.length >= 2){
        const lines = [];
        for (let i = 0; i < core.length; i++){
          for (let j = i+1; j < core.length; j++){
            if ((i + j) % 4 !== 0) continue; // sparse
            lines.push([[core[i].lat, core[i].lng], [core[j].lat, core[j].lng]]);
          }
        }
        if (lines.length){
          L.polyline(lines, {
            color: "rgba(27,63,191,.35)",
            weight: 1.5,
            opacity: 0.55,
            dashArray: "6 10"
          }).addTo(map);
        }
      }

      applyMarkerStyles();
      fitAll();
    }

    function applyMarkerStyles(){
      for (const c of COUNTRIES){
        const m = markersById.get(c.id);
        if (!m) continue;

        const base = statusColor(c.status);
        const isCore = (c.status === "member" || c.status === "founding");
        const isSelected = (selectedId === c.id);

        const dim = memberHighlight ? (!isCore ? 0.30 : 0.72) : 0.70;
        const fill = memberHighlight ? (!isCore ? 0.22 : 0.62) : 0.60;

        // ‚Äúspecial‚Äù should remain visible even when highlight is on
        const isSpecial = (c.status === "special");
        const finalOpacity = isSpecial ? Math.max(dim, 0.62) : dim;
        const finalFill = isSpecial ? Math.max(fill, 0.55) : fill;

        m.setStyle({
          color: base,
          fillColor: base,
          opacity: finalOpacity,
          fillOpacity: finalFill,
          weight: isSelected ? 3 : 2,
          radius: isSelected ? 10 : ((c.status === "founding" || c.status === "special") ? 9 : 8),
        });
      }
    }

    function fitAll(){
      if (!map) return;
      const latlngs = COUNTRIES.map(c => [c.lat, c.lng]);
      map.fitBounds(L.latLngBounds(latlngs).pad(0.22));
    }

    function zoomToSelected(){
      const c = getSelected();
      if (!c || !map) return;
      map.flyTo([c.lat, c.lng], Math.max(map.getZoom(), 4), { duration: 0.8 });
    }

    /**********************************************************************
     * Drawer / selection
     **********************************************************************/
    const drawer = el("drawer");
    const drawerBody = el("drawerBody");

    const selName = el("selName");
    const selStatus = el("selStatus");

    function getSelected(){
      return COUNTRIES.find(c => c.id === selectedId) || null;
    }

    function setStatusLine(country){
      if (!country){
        selName.textContent = "No selection";
        selStatus.textContent = "‚Äî";
        return;
      }
      selName.textContent = country.name;
      selStatus.textContent = statusLabel(country.status);
    }

    function setDrawer(country){
      if (!country) return;

      el("dFlag").textContent = country.flag || "üè≥Ô∏è";
      el("dName").textContent = country.name;

      const b = el("dBadge");
      b.className = `badge ${badgeClass(country.status)}`;
      b.textContent = statusLabel(country.status);

      const mini = [];
      if (country.capital) mini.push(`Capital: ${country.capital}`);
      if (country.region) mini.push(country.region);
      el("dMini").textContent = mini.join(" ‚Ä¢ ") || "‚Äî";

      // Body: richer info (edit in COUNTRIES)
      const blocks = [];

      blocks.push(`
        <div class="card">
          <h3>Overview</h3>
          <p class="note" style="margin:0;">${escapeHTML(country.short || "‚Äî")}</p>
        </div>
      `);

      blocks.push(`
        <div class="card">
          <h3>Key Facts</h3>
          <div class="grid2">
            <div class="kv"><div class="k">Status</div><div class="v">${escapeHTML(statusLabel(country.status))}</div></div>
            <div class="kv"><div class="k">OFN Role</div><div class="v">${escapeHTML(country.ofnRole || "‚Äî")}</div></div>
            <div class="kv"><div class="k">Alignment</div><div class="v">${escapeHTML(country.alignment || "‚Äî")}</div></div>
            <div class="kv"><div class="k">Coordinates</div><div class="v">${country.lat.toFixed(4)}, ${country.lng.toFixed(4)}</div></div>
          </div>
        </div>
      `);

      const detailRows = Array.isArray(country.details) ? country.details : [];
      if (detailRows.length){
        blocks.push(`
          <div class="card">
            <h3>Briefing Notes</h3>
            <div style="display:flex;flex-direction:column;gap:10px;">
              ${detailRows.map(r => `
                <div class="kv">
                  <div class="k">${escapeHTML(r.k || "‚Äî")}</div>
                  <div class="v">${escapeHTML(r.v || "‚Äî")}</div>
                </div>
              `).join("")}
            </div>
          </div>
        `);
      }

      blocks.push(`
        <div class="card">
          <h3>Editing tip</h3>
          <p class="note" style="margin:0;">
            Update this nation‚Äôs fields inside <code>COUNTRIES</code> in the HTML and push to GitHub ‚Äî
            Netlify will auto-redeploy.
          </p>
        </div>
      `);

      drawerBody.innerHTML = blocks.join("");
    }

    function openDrawer(){ drawer.classList.add("open"); }
    function closeDrawer(){ drawer.classList.remove("open"); }

    function selectCountry(id, opts = { pan:false, openDrawer:true }){
      const c = COUNTRIES.find(x => x.id === id);
      if (!c) return;

      selectedId = id;
      setStatusLine(c);
      applyMarkerStyles();

      const m = markersById.get(id);
      if (m){
        m.bindPopup(`<b>${escapeHTML(c.flag || "üè≥Ô∏è")} ${escapeHTML(c.name)}</b><br>${escapeHTML(statusLabel(c.status))}`).openPopup();
      }

      setDrawer(c);
      if (opts.openDrawer) openDrawer();
      if (opts.pan) zoomToSelected();
    }

    /**********************************************************************
     * Filtering (search/filter affects which markers are ‚Äúprominent‚Äù)
     * - You wanted: scroll/zoom out shows specials in different color (done)
     * - and: can click any nation (done)
     * - filtering will hide/dim non-matching markers (still clickable if not fully hidden)
     **********************************************************************/
    const searchEl = el("search");
    const filterEl = el("filter");

    function applyFilter(){
      const q = (searchEl.value || "").trim().toLowerCase();
      const f = filterEl.value;

      for (const c of COUNTRIES){
        const m = markersById.get(c.id);
        if (!m) continue;

        const matchFilter = (f === "all") ? true : c.status === f;
        const hay = `${c.name} ${c.capital || ""} ${c.region || ""} ${c.status}`.toLowerCase();
        const matchQuery = !q ? true : hay.includes(q);
        const match = matchFilter && matchQuery;

        // ‚ÄúHidden‚Äù markers still exist but are highly transparent; still clickable if you find them.
        // If you want true hiding: set radius 0 + opacity 0 and disable pointer events (harder in Leaflet).
        m.setStyle({
          opacity: match ? undefined : 0.15,
          fillOpacity: match ? undefined : 0.08,
          radius: match ? undefined : 6
        });
      }

      // then re-apply member highlight & selected emphasis on top
      applyMarkerStyles();
    }

    /**********************************************************************
     * Intro animation: ring of member flags as ‚Äústars‚Äù, then fly away
     **********************************************************************/
    const intro = el("intro");
    const introCanvas = el("introCanvas");
    const introCount = el("introCount");
    const introLine = el("introLine");
    const skipIntro = el("skipIntro");

    function runIntro(){
      const ctx = introCanvas.getContext("2d", { alpha: true });
      if (!ctx){
        finishIntro();
        return;
      }

      const members = COUNTRIES.filter(c => c.status === "member" || c.status === "founding");
      introCount.textContent = String(members.length);

      // canvas sizing
      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        introCanvas.width = Math.floor(introCanvas.clientWidth * dpr);
        introCanvas.height = Math.floor(introCanvas.clientHeight * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize, { passive:true });

      // Pre-render ‚Äúflag star‚Äù sprites (emoji flags)
      const sprites = members.map(m => ({
        c: m,
        phase: Math.random()*Math.PI*2,
        jitter: 0.8 + Math.random()*0.6,
      }));

      let start = performance.now();
      let stage = "orbit"; // orbit -> fly -> done
      const orbitDuration = 2.6;   // seconds
      const flyDuration = 0.9;     // seconds
      const total = orbitDuration + flyDuration;

      introLine.textContent = "Aligning constellations‚Ä¶";

      function draw(now){
        const t = (now - start) / 1000;
        const w = introCanvas.clientWidth;
        const h = introCanvas.clientHeight;

        ctx.clearRect(0,0,w,h);

        const cx = w*0.5, cy = h*0.52;
        const R = Math.min(w,h)*0.28;

        // soft EU-blue glow
        const glow = ctx.createRadialGradient(cx, cy, 10, cx, cy, R*2.2);
        glow.addColorStop(0, "rgba(43,109,255,.16)");
        glow.addColorStop(0.5, "rgba(43,109,255,.06)");
        glow.addColorStop(1, "rgba(255,255,255,0)");
        ctx.fillStyle = glow;
        ctx.fillRect(0,0,w,h);

        // ring
        ctx.strokeStyle = "rgba(27,63,191,.22)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(cx, cy, R, 0, Math.PI*2);
        ctx.stroke();

        // center star (gold)
        const pulse = 0.5 + 0.5*Math.sin(t*2.0);
        ctx.fillStyle = `rgba(255,204,51,${0.22 + 0.12*pulse})`;
        ctx.beginPath();
        ctx.arc(cx, cy, 4 + 2*pulse, 0, Math.PI*2);
        ctx.fill();

        // stage calculation
        let orbitT = Math.min(t / orbitDuration, 1);
        let flyT = Math.max(0, (t - orbitDuration) / flyDuration);
        flyT = Math.min(flyT, 1);

        if (t > orbitDuration && stage === "orbit"){
          stage = "fly";
          introLine.textContent = "Unifying ‚Äî welcome.";
        }
        if (t > total){
          finishIntro();
          return;
        }

        // nodes
        const n = sprites.length || 1;
        const spin = t * 0.65;

        for (let i=0;i<sprites.length;i++){
          const s = sprites[i];
          const a0 = (i/n)*Math.PI*2 + spin;
          const wob = 1 + 0.02*Math.sin(t*3.0 + s.phase);
          let rr = R*wob;

          // Fly-away behavior: push outward + fade
          const flyOut = (stage === "fly") ? (1 + flyT*1.2) : 1;
          rr *= flyOut;

          const x = cx + Math.cos(a0)*rr;
          const y = cy + Math.sin(a0)*rr;

          const alpha = (stage === "fly") ? (1 - flyT) : 1;

          // gold ‚Äústar‚Äù glow behind flag
          ctx.globalAlpha = 0.75 * alpha;
          ctx.fillStyle = "rgba(255,204,51,.22)";
          ctx.beginPath();
          ctx.arc(x, y, 16, 0, Math.PI*2);
          ctx.fill();

          // draw flag ‚Äútexture‚Äù
          ctx.globalAlpha = 1 * alpha;
          ctx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(s.c.flag || "‚òÖ", x, y);

          // tiny orbit line shimmer
          if (stage === "orbit" && (i % 3 === 0)){
            ctx.globalAlpha = 0.25;
            ctx.strokeStyle = "rgba(27,63,191,.18)";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(cx, cy);
            ctx.stroke();
          }

          ctx.globalAlpha = 1;
        }

        requestAnimationFrame(draw);
      }

      requestAnimationFrame(draw);
    }

    function finishIntro(){
      intro.classList.add("hidden");
      setTimeout(() => intro.remove(), 700);
    }

    /**********************************************************************
     * Wire up UI
     **********************************************************************/
    function wireUI(){
      el("closeBtn").addEventListener("click", closeDrawer);
      el("zoomBtn").addEventListener("click", zoomToSelected);

      el("fitBtn").addEventListener("click", fitAll);

      el("modeBtn").addEventListener("click", () => {
        memberHighlight = !memberHighlight;
        el("modeBtn").textContent = `Member Highlight: ${memberHighlight ? "ON" : "OFF"}`;
        applyMarkerStyles();
        applyFilter(); // keep filter result consistent
      });

      searchEl.addEventListener("input", applyFilter);
      filterEl.addEventListener("change", applyFilter);

      skipIntro.addEventListener("click", finishIntro);

      // Close drawer when clicking outside (on map) if open and no popup clicked
      document.addEventListener("click", (e) => {
        if (!drawer.classList.contains("open")) return;
        const withinDrawer = drawer.contains(e.target);
        const withinTopbar = el("topbar").contains(e.target);
        const isLeafletPopup = String(e.target.className || "").includes("leaflet");
        if (!withinDrawer && !withinTopbar && !isLeafletPopup){
          // don't close if user clicked a marker (Leaflet handles it)
          // small delay to allow marker selection to open drawer
          setTimeout(() => {
            const c = getSelected();
            // keep open if a selection exists (you can comment this if you want click-outside to always close)
            if (!c) closeDrawer();
          }, 0);
        }
      }, { capture:true });

      // ESC closes drawer
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeDrawer();
      });
    }

    /**********************************************************************
     * Boot
     **********************************************************************/
    (function boot(){
      wireUI();
      initMap();

      // Pick a friendly default selection? You said drawer should only show on click,
      // so we do NOT auto-open. Statusline stays ‚ÄúNo selection‚Äù.
      setStatusLine(null);

      // Intro ring
      runIntro();

      // If user is offline, OSM tiles may not load; but everything else still works.
      // (No debug panels‚Äîjust quiet behavior.)
    })();
  </script>
</body>
</html>
