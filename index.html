<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Organisation of Free Nations</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --line:#d7deef;
      --line2:#c9d2ea;
      --text:#0f1b3a;
      --muted:#51607f;

      --member:#1b3fbf;
      --founding:#ffcc33;
      --observer:#f2994a;
      --invite:#18a999;
      --conflict:#e23b3b;
      --neutral:#9bb0cf;

      --shadow: 0 10px 26px rgba(15,27,58,.12);
      --shadow2: 0 6px 16px rgba(15,27,58,.10);
      --r:18px;
      --r2:22px;
    }

    :root[data-theme="night"]{
      --bg:#070b16;
      --card: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.14);
      --line2: rgba(255,255,255,.20);
      --text:#eef3ff;
      --muted: rgba(238,243,255,.72);

      --shadow: 0 12px 28px rgba(0,0,0,.40);
      --shadow2: 0 8px 18px rgba(0,0,0,.32);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text); background:linear-gradient(180deg,#fff,var(--bg)); overflow:hidden; }
    :root[data-theme="night"] body{
      background: radial-gradient(900px 600px at 50% 15%, rgba(43,109,255,.12), transparent 60%),
                  linear-gradient(180deg, #040611 0%, #070b16 55%, #0a1022 100%);
    }

    #map{ position:fixed; inset:0; z-index:1; }

    #topbar{
      position:fixed; z-index:30;
      left:16px; right:16px; top:14px;
      min-height:60px;
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      background:rgba(255,255,255,.90);
      border:1px solid var(--line);
      border-radius:var(--r2);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      opacity:0;
      transform: translateY(-6px);
      pointer-events:none;
      transition: opacity .28s ease, transform .28s ease, background .16s ease, border-color .16s ease;
    }
    #topbar.ready{
      opacity:1; transform: translateY(0);
      pointer-events:auto;
    }

    :root[data-theme="night"] #topbar,
    :root[data-theme="night"] #statusline,
    :root[data-theme="night"] #drawer,
    :root[data-theme="night"] #fictionPanel{
      background: rgba(10,14,28,.80) !important;
      border-color: rgba(255,255,255,.14) !important;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:260px; }
    .emblem{
      width:38px; height:38px; border-radius:14px;
      border:1px solid var(--line);
      background: radial-gradient(circle at 35% 30%, rgba(43,109,255,.35), rgba(27,63,191,.10) 55%, rgba(255,255,255,1) 100%);
      box-shadow: 0 0 0 6px rgba(27,63,191,.06);
      position:relative; overflow:hidden;
      flex:0 0 auto;
    }
    .emblem:after{
      content:"";
      position:absolute; inset:-35%;
      background: conic-gradient(from 200deg, rgba(255,204,51,.0) 0 20%, rgba(255,204,51,.35) 20% 26%, rgba(255,204,51,0) 26% 55%, rgba(43,109,255,.22) 55% 62%, rgba(255,204,51,0) 62% 100%);
      animation: spin 10s linear infinite;
      opacity:.9;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .brand h1{ margin:0; font-size:13px; letter-spacing:.18em; text-transform:uppercase; color:var(--member); }
    .brand .sub{ margin:2px 0 0 0; font-size:12px; color:var(--muted); }

    .controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    input, select, button{
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:9px 12px;
      outline:none;
      box-shadow:0 0 0 0 rgba(43,109,255,0);
      transition: box-shadow .16s ease, border-color .16s ease, transform .10s ease, background .16s ease, color .16s ease;
    }
    input{ min-width: 220px; }
    input::placeholder{ color: rgba(81,96,127,.65); }
    button{ cursor:pointer; background: linear-gradient(180deg,#fff,#f7f9ff); }
    button:hover{ border-color: var(--line2); box-shadow: 0 0 0 4px rgba(43,109,255,.10); }
    button:active{ transform: translateY(1px); }
    .primary{
      border-color: rgba(27,63,191,.25);
      background: linear-gradient(180deg, rgba(43,109,255,.12), rgba(27,63,191,.06));
    }

    :root[data-theme="night"] input,
    :root[data-theme="night"] select,
    :root[data-theme="night"] button{
      background: rgba(255,255,255,.10);
      color: var(--text);
      border-color: rgba(255,255,255,.16);
    }
    :root[data-theme="night"] input::placeholder{ color: rgba(238,243,255,.55); }

    #statusline{
      position:fixed; z-index:25;
      left:16px; bottom:16px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      display:flex; gap:10px; align-items:center;
      color:var(--muted);
      max-width: calc(100vw - 32px);
      opacity:0;
      transform: translateY(6px);
      pointer-events:none;
      transition: opacity .28s ease, transform .28s ease;
    }
    #statusline.ready{ opacity:1; transform: translateY(0); pointer-events:auto; }
    .pillDot{ width:9px; height:9px; border-radius:50%; background:var(--member); box-shadow: 0 0 0 4px rgba(43,109,255,.12); }
    #statusline b{ color:var(--text); }

    #drawer{
      position:fixed; z-index:35;
      top:88px; left:16px; bottom:16px;
      width:min(460px, calc(100vw - 32px));
      background:rgba(255,255,255,.94);
      border:1px solid var(--line);
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      transform: translateX(-112%);
      transition: transform .22s ease;
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    #drawer.open{ transform: translateX(0); }

    .drawerHead{
      padding:14px 14px 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg,#fff, rgba(247,249,255,.85));
    }
    :root[data-theme="night"] .drawerHead{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-bottom-color: rgba(255,255,255,.12);
    }

    .drawerTitle{ display:flex; align-items:center; gap:10px; min-width:0; }
    .flagBig{
      width:44px; height:44px; border-radius:16px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:0 0 0 6px rgba(27,63,191,.06);
      font-size:22px;
      flex:0 0 auto;
    }
    :root[data-theme="night"] .flagBig{ background: rgba(255,255,255,.10); }

    .titleText{ min-width:0; }
    .titleText h2{ margin:0; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .titleText .mini{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }

    .badge{
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    :root[data-theme="night"] .badge{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.16);
      color: rgba(238,243,255,.78);
    }

    .badge.member{ border-color: rgba(43,109,255,.40); color:#1033a3; }
    .badge.founding{ border-color: rgba(255,204,51,.60); color:#7c5b00; }
    .badge.observer{ border-color: rgba(242,153,74,.55); color:#7b3f00; }
    .badge.invite{ border-color: rgba(24,169,153,.55); color:#0b5b51; }
    .badge.conflict{ border-color: rgba(226,59,59,.55); color:#7b1414; }
    .badge.hq{ border-color: rgba(27,63,191,.40); color:#1033a3; }

    :root[data-theme="night"] .badge.member{ color: rgba(180,210,255,.90); }
    :root[data-theme="night"] .badge.founding{ color: rgba(255,236,170,.92); }
    :root[data-theme="night"] .badge.observer{ color: rgba(255,210,170,.92); }
    :root[data-theme="night"] .badge.invite{ color: rgba(170,255,235,.92); }
    :root[data-theme="night"] .badge.conflict{ color: rgba(255,180,190,.92); }
    :root[data-theme="night"] .badge.hq{ color: rgba(180,210,255,.90); }

    .drawerActions{ display:flex; gap:8px; align-items:center; }
    .iconBtn{
      width:38px; height:38px; border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      display:grid; place-items:center;
    }
    :root[data-theme="night"] .iconBtn{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.16); color: var(--text); }
    .iconBtn:hover{ box-shadow: 0 0 0 4px rgba(43,109,255,.10); }

    .drawerBody{
      padding:12px 14px 14px 14px;
      overflow:auto;
      display:flex; flex-direction:column; gap:10px;
      min-height:0;
    }
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:#fff;
      box-shadow: 0 6px 14px rgba(15,27,58,.06);
      padding:12px;
    }
    :root[data-theme="night"] .card{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.14);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }

    .card h3{
      margin:0 0 8px 0;
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .kv{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background: linear-gradient(180deg,#fff,#fbfcff);
    }
    :root[data-theme="night"] .kv{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.06));
      border-color: rgba(255,255,255,.14);
    }
    .kv .k{
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .kv .v{ margin-top:4px; font-weight:650; color:var(--text); overflow-wrap:anywhere; }
    .note{ margin:0; color:var(--muted); }
    .link{ color: var(--member); text-decoration: none; border-bottom: 1px dotted rgba(27,63,191,.35); }
    .link:hover{ border-bottom-color: rgba(27,63,191,.75); }

    #intro{
      position:fixed; inset:0; z-index:60;
      background:#ffffff;
      display:grid; place-items:center;
      transition: opacity .28s ease;
    }
    #intro.hidden{ opacity:0; pointer-events:none; }
    #introCanvas{
      width:min(760px, calc(100vw - 36px));
      height:360px;
      display:block;
    }

    /* --- Fictional panel (right-middle, pull-out) --- */
    #fictionPanel{
      position:fixed; z-index:34;
      right:16px;
      top:50%;
      transform: translateY(-50%);
      width: 320px;
      max-height: min(520px, calc(100vh - 140px));
      background: rgba(255,255,255,.94);
      border: 1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow: hidden;
      display:flex;
      transition: transform .22s ease;
    }

    /* closed state slides almost fully off-screen, leaving the handle visible */
    #fictionPanel.closed{
      transform: translate( calc(100% - 46px), -50% );
    }

    .fictionHandle{
      width:46px;
      border-right: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg,#fff, rgba(247,249,255,.85));
      flex:0 0 auto;
    }
    :root[data-theme="night"] .fictionHandle{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-right-color: rgba(255,255,255,.12);
    }

    .fictionHandle button{
      width:34px; height:34px;
      padding:0;
      border-radius:999px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
    }
    :root[data-theme="night"] .fictionHandle button{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.16);
      color: var(--text);
    }
    .fictionHandle button:hover{ box-shadow: 0 0 0 4px rgba(43,109,255,.10); }

    .fictionBody{
      padding:12px 12px 12px 12px;
      overflow:auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      width: calc(320px - 46px);
    }
    .fictionTitle{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      padding-bottom:8px;
      border-bottom:1px solid var(--line);
    }
    :root[data-theme="night"] .fictionTitle{ border-bottom-color: rgba(255,255,255,.12); }

    .fictionTitle h3{
      margin:0;
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .fictionHint{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .fictionList{ display:flex; flex-direction:column; gap:8px; }
    .fictionItem{
      border-radius: 16px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg,#fff,#fbfcff);
      padding:10px;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      transition: transform .10s ease, border-color .16s ease, box-shadow .16s ease;
    }
    :root[data-theme="night"] .fictionItem{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.06));
      border-color: rgba(255,255,255,.14);
    }
    .fictionItem:hover{
      border-color: var(--line2);
      box-shadow: 0 0 0 4px rgba(43,109,255,.08);
    }
    .fictionItem:active{ transform: translateY(1px); }

    .fictionItem .left{ min-width:0; }
    .fictionItem .name{
      font-weight: 750;
      margin:0;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .fictionItem .sub{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .fictionItem .right{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; }
    .miniBadge{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    :root[data-theme="night"] .miniBadge{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.16);
      color: rgba(238,243,255,.78);
    }
    .miniBadge.member{ border-color: rgba(43,109,255,.40); color:#1033a3; }
    .miniBadge.invite{ border-color: rgba(24,169,153,.55); color:#0b5b51; }
    .miniBadge.neutral{ border-color: rgba(155,176,207,.70); color:#2c3a55; }
    :root[data-theme="night"] .miniBadge.member{ color: rgba(180,210,255,.90); }
    :root[data-theme="night"] .miniBadge.invite{ color: rgba(170,255,235,.92); }
    :root[data-theme="night"] .miniBadge.neutral{ color: rgba(210,225,255,.82); }

    .leaflet-control-attribution{
      background: rgba(255,255,255,.90) !important;
      border: 1px solid var(--line) !important;
      border-radius: 12px !important;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      color: var(--muted) !important;
    }
    :root[data-theme="night"] .leaflet-control-attribution{
      background: rgba(10,14,28,.80) !important;
      border-color: rgba(255,255,255,.14) !important;
      color: rgba(238,243,255,.70) !important;
    }

    .leaflet-control-zoom a{
      background: rgba(255,255,255,.92) !important;
      border: 1px solid var(--line) !important;
      color: var(--text) !important;
    }
    :root[data-theme="night"] .leaflet-control-zoom a{
      background: rgba(10,14,28,.80) !important;
      border-color: rgba(255,255,255,.14) !important;
      color: rgba(238,243,255,.92) !important;
    }

    .leaflet-popup-content-wrapper, .leaflet-popup-tip{
      background: rgba(255,255,255,.96) !important;
      border: 1px solid var(--line) !important;
      box-shadow: var(--shadow2);
      color: var(--text) !important;
      backdrop-filter: blur(10px);
    }
    :root[data-theme="night"] .leaflet-popup-content-wrapper,
    :root[data-theme="night"] .leaflet-popup-tip{
      background: rgba(10,14,28,.88) !important;
      border-color: rgba(255,255,255,.14) !important;
      color: rgba(238,243,255,.92) !important;
    }

    @media (max-width: 720px){
      #topbar{ left:12px; right:12px; }
      #statusline{ left:12px; right:12px; max-width: calc(100vw - 24px); }
      #drawer{ left:12px; width: calc(100vw - 24px); }
      input{ min-width: 160px; }
      .grid2{ grid-template-columns:1fr; }
      #introCanvas{ height:300px; }

      /* Fiction panel a bit smaller on mobile */
      #fictionPanel{ right:12px; width: 300px; }
      #fictionPanel.closed{ transform: translate( calc(100% - 44px), -50% ); }
      .fictionHandle{ width:44px; }
      .fictionBody{ width: calc(300px - 44px); }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="topbar" role="banner">
    <div class="brand">
      <div class="emblem" aria-hidden="true"></div>
      <div>
        <h1>Organisation of Free Nations</h1>
        <div class="sub">Interactive map</div>
      </div>
    </div>

    <div class="controls" role="toolbar" aria-label="Controls">
      <input id="search" type="text" placeholder="Search any country‚Ä¶" spellcheck="false" />
      <select id="filter">
        <option value="all">All statuses</option>
        <option value="member">Member</option>
        <option value="founding">Founding</option>
        <option value="observer">Observer</option>
        <option value="invite">Open invite</option>
        <option value="conflict">Conflict</option>
        <option value="neutral">Neutral</option>
      </select>
      <select id="theme">
        <option value="auto">Theme: Auto</option>
        <option value="day">Theme: Day</option>
        <option value="night">Theme: Night</option>
      </select>
      <select id="links">
        <option value="off">Links: Off</option>
        <option value="diplomatic">Links: Diplomatic</option>
        <option value="trade">Links: Trade</option>
        <option value="political">Links: Political</option>
        <option value="all">Links: All</option>
      </select>
      <button id="focusBtn" type="button">Member focus: Off</button>
      <button id="fitBtn" type="button">Fit</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <div id="statusline" aria-live="polite">
    <span class="pillDot"></span>
    <span><b id="selName">No selection</b> ¬∑ <span id="selStatus">‚Äî</span></span>
  </div>

  <!-- Fictional nations pull-out (right-middle) -->
  <aside id="fictionPanel" class="closed" aria-label="Fictional nations panel">
    <div class="fictionHandle">
      <button id="fictionToggle" type="button" title="Toggle fictional nations">‚óÄ</button>
    </div>
    <div class="fictionBody">
      <div class="fictionTitle">
        <h3>Fictional nations</h3>
        <div class="fictionHint">click to open</div>
      </div>
      <div class="fictionList" id="fictionList"></div>
    </div>
  </aside>

  <aside id="drawer" aria-label="Country details panel">
    <div class="drawerHead">
      <div class="drawerTitle">
        <div class="flagBig" id="dFlag">üåç</div>
        <div class="titleText">
          <h2 id="dName">‚Äî</h2>
          <div class="mini" id="dMini"></div>
        </div>
      </div>
      <div class="drawerActions">
        <button class="iconBtn" id="zoomBtn" type="button" title="Zoom to country">‚§¢</button>
        <button class="iconBtn" id="closeBtn" type="button" title="Close">‚úï</button>
      </div>
    </div>
    <div class="drawerBody" id="drawerBody"></div>
  </aside>

  <section id="intro" aria-label="Loading">
    <canvas id="introCanvas"></canvas>
  </section>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const OFN = {
      members: new Set(["Luxembourg","Falkland Islands","Israel","United States of America","Philippines","Brazil","Australia","Greece"]),
      founding: new Set(["Falkland Islands"]),
      observer: new Set(["China"]),
      invite: new Set(["Japan"]),
      conflict: new Set(["Germany"]),
      hq: "Luxembourg"
    };

    // Fictional nations (not on the real-world map)
    const FICTIONAL = new Map([
      ["State of Mayflower (Union of Columbia)", {
        status: "member",
        flag: "üü¶",
        meta: {
          "Polity": "Union of Columbia (Mayflower)",
          "Seat of government": "City of Lander (County of Clark)",
          "Administrative areas": "New Haven ¬∑ Lee ¬∑ Clark ¬∑ Elizabeth"
        },
        overview: [
          "The State of Mayflower was established along the northeast coast of the current day Union of Columbia by colonizers hailing from Pax Britannia in December of 1771.",
          "The State of Mayflower had human settlements within its boundaries as early as 1625, with human settlements from the Kingdom of Wallonia sporadically being created along the coast.",
          "The state was established as an entity of the Union of Columbia on 4 July 1776 proceeding the uprising against Pax Britannia for independence.",
          "The state ecompasses a variety of natural areas, including rivers, mountains, valleys, and numerous accompanying waterways that divide land into islands that create state boundaries.",
          "The state is made up the administrative areas of the County of New Haven, County of Lee, County of Clark, and the County of Elizabeth.",
          "The state is seated in the City of Lander in the County of Clark."
        ].join("\n\n")
      }],
      ["State of Ashford", {
        status: "neutral",
        flag: "üü™",
        meta: {
          "Status": "United States territory",
          "Founded": "1763",
          "Capital": "Ember Township (formerly Ember City)"
        },
        overview: [
          "The State of Ashford, also known as Ashford, was founded in 1763 by settlers who crossed the Atlantic seeking freedom and opportunity under the leadership of Sir Clifford. Their journey was marked by hardship and tragedy, including a pirate attack that claimed many lives, among them Sir Clifford himself.",
          "In their memory, the settlers built Ember City, later known as Ember Township, and named their land Ashford. A symbol of resilience born from loss and determination.",
          "Today, Ashford stands proudly as a United States territory in Washington, committed to the values of liberty, democracy, and cooperation."
        ].join("\n\n")
      }],
      ["State of Firestone", {
        status: "invite",
        flag: "üü©",
        meta: {
          "Founded": "April 1st, 2016",
          "Founders": "FedoraMasterB98 ¬∑ pathwaysbball",
          "Current owner": "Poe_DameronTR",
          "Motto": "United We Stand"
        },
        overview: [
          "The State of Firestone, founded on April 1st, 2016 by FedoraMasterB98 and pathwaysbball, is a longstanding and prominent Ro-State roleplay community based within the United States. Now under the ownership of Poe_DameronTR, Firestone is entering a new era one focused on revitalization, transparency, and delivering a more immersive experience for all.",
          "Since its creation, Firestone has allowed members to step into government, law enforcement, civilian, and criminal roles in a dynamic and realistic environment. Our core belief \"United We Stand\" remains stronger than ever as we work toward uniting the community through collaboration, innovation, and renewed purpose."
        ].join("\n\n")
      }]
    ]);

    const NAME_ALIASES = new Map([
      ["United States", "United States of America"],
      ["USA", "United States of America"]
    ]);

    function canonicalName(name){
      const n = (name || "").trim();
      return NAME_ALIASES.get(n) || n;
    }

    function statusOf(name){
      const n = canonicalName(name);

      // If fictional, use its own status
      if (FICTIONAL.has(n)) return FICTIONAL.get(n).status;

      if (OFN.founding.has(n)) return "founding";
      if (OFN.members.has(n)) return "member";
      if (OFN.observer.has(n)) return "observer";
      if (OFN.invite.has(n)) return "invite";
      if (OFN.conflict.has(n)) return "conflict";
      return "neutral";
    }

    function statusLabel(s){
      return ({
        founding:"Founding nation",
        member:"Member nation",
        observer:"Observer state",
        invite:"Open invite",
        conflict:"Conflict",
        neutral:"Neutral"
      }[s] || "Neutral");
    }

    function statusColor(s){
      const css = getComputedStyle(document.documentElement);
      return ({
        member: css.getPropertyValue("--member").trim(),
        founding: css.getPropertyValue("--founding").trim(),
        observer: css.getPropertyValue("--observer").trim(),
        invite: css.getPropertyValue("--invite").trim(),
        conflict: css.getPropertyValue("--conflict").trim(),
        neutral: css.getPropertyValue("--neutral").trim()
      }[s] || css.getPropertyValue("--neutral").trim());
    }

    function badgeClass(s){
      return ({
        member:"member",
        founding:"founding",
        observer:"observer",
        invite:"invite",
        conflict:"conflict",
        neutral:"neutral"
      }[s] || "neutral");
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    const el = (id) => document.getElementById(id);
    const normalize = (s) => (s||"").toLowerCase().replace(/\s+/g," ").trim();

    let map, countriesLayer, linksLayer = null;
    let selectedFeature = null;
    let selectedName = null;

    let memberFocus = false;

    const topbar = el("topbar");
    const statusline = el("statusline");
    const drawer = el("drawer");
    const drawerBody = el("drawerBody");

    function getAutoTheme(){
      const h = new Date().getHours();
      return (h >= 7 && h < 19) ? "day" : "night";
    }

    function applyTheme(mode){
      const root = document.documentElement;
      let actual = mode;
      if (mode === "auto") actual = getAutoTheme();
      if (actual === "night") root.setAttribute("data-theme", "night");
      else root.removeAttribute("data-theme");
      setTimeout(() => refreshLinks(), 0);

      // update fictional toggle arrow direction based on open/closed
      syncFictionToggleIcon();
    }

    function startThemeClock(){
      setInterval(() => {
        const sel = el("theme");
        if (sel && sel.value === "auto") applyTheme("auto");
      }, 60 * 1000);
    }

    function setStatusLine(name){
      if (!name){
        el("selName").textContent = "No selection";
        el("selStatus").textContent = "‚Äî";
        return;
      }
      const s = statusOf(name);
      el("selName").textContent = name;
      el("selStatus").textContent = statusLabel(s);
    }

    function openDrawer(){ drawer.classList.add("open"); }
    function closeDrawer(){ drawer.classList.remove("open"); }

    function makeBadge(text, cls){
      return `<span class="badge ${cls}">${escapeHTML(text)}</span>`;
    }

    function situationBadges(name){
      const s = statusOf(name);
      const badges = [];
      badges.push(makeBadge(statusLabel(s), badgeClass(s)));
      if (canonicalName(name) === OFN.hq) badges.push(makeBadge("Headquarters", "hq"));
      if (FICTIONAL.has(canonicalName(name))) badges.push(makeBadge("Fictional", "hq"));
      return badges.join("");
    }

    function setDrawerHeader(name){
      const n = canonicalName(name);
      el("dName").textContent = n;

      // For fictional: use its icon; otherwise globe
      if (FICTIONAL.has(n)){
        el("dFlag").textContent = FICTIONAL.get(n).flag || "üó∫Ô∏è";
      } else {
        el("dFlag").textContent = "üåç";
      }

      el("dMini").innerHTML = situationBadges(n);
    }

    async function fetchWikiSummary(title){
      const t = encodeURIComponent(title.replace(/\s+/g, "_"));
      const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${t}`;
      const res = await fetch(url, { headers: { "accept":"application/json" } });
      if (!res.ok) throw new Error("wiki");
      return await res.json();
    }

    function paragraphsToHtml(text){
      const parts = String(text || "").split(/\n\s*\n/g).map(s => s.trim()).filter(Boolean);
      if (!parts.length) return `<p class="note" style="margin:0;">‚Äî</p>`;
      return parts.map(p => `<p class="note" style="margin:0 0 10px 0;">${escapeHTML(p)}</p>`).join("").replace(/<\/p>$/, "</p>");
    }

    function renderMetaGrid(meta){
      if (!meta) return "";
      const entries = Object.entries(meta);
      if (!entries.length) return "";
      const items = entries.map(([k,v]) => `
        <div class="kv">
          <div class="k">${escapeHTML(k)}</div>
          <div class="v">${escapeHTML(v)}</div>
        </div>
      `).join("");
      return `<div class="grid2">${items}</div>`;
    }

    function fillDrawerFictional(name){
      const n = canonicalName(name);
      const data = FICTIONAL.get(n);
      if (!data){
        setDrawerHeader(n);
        drawerBody.innerHTML = `<div class="card"><h3>Overview</h3><p class="note" style="margin:0;">No local record found.</p></div>`;
        return;
      }

      setDrawerHeader(n);

      const s = statusOf(n);
      const cards = [];

      cards.push(`
        <div class="card">
          <h3>Status</h3>
          <div class="grid2">
            <div class="kv"><div class="k">Designation</div><div class="v">${escapeHTML(statusLabel(s))}</div></div>
            <div class="kv"><div class="k">OFN</div><div class="v">${escapeHTML((canonicalName(n) === OFN.hq) ? "Headquarters" : "‚Äî")}</div></div>
          </div>
        </div>
      `);

      if (data.meta){
        cards.push(`
          <div class="card">
            <h3>Key facts</h3>
            ${renderMetaGrid(data.meta)}
          </div>
        `);
      }

      cards.push(`
        <div class="card">
          <h3>Overview</h3>
          ${paragraphsToHtml(data.overview)}
        </div>
      `);

      drawerBody.innerHTML = cards.join("");
    }

    async function fillDrawerFromInternet(name){
      const n = canonicalName(name);

      // Fictional bypass (no Wikipedia)
      if (FICTIONAL.has(n)){
        fillDrawerFictional(n);
        return;
      }

      setDrawerHeader(n);

      const s = statusOf(n);
      const cards = [];

      cards.push(`
        <div class="card">
          <h3>Status</h3>
          <div class="grid2">
            <div class="kv"><div class="k">Designation</div><div class="v">${escapeHTML(statusLabel(s))}</div></div>
            <div class="kv"><div class="k">OFN</div><div class="v">${escapeHTML((canonicalName(n) === OFN.hq) ? "Headquarters" : "‚Äî")}</div></div>
          </div>
        </div>
      `);

      let wiki = null;

      try{
        wiki = await fetchWikiSummary(n);
      }catch(_){
        if (n === "United States of America"){
          try{ wiki = await fetchWikiSummary("United States"); }catch(__){}
        }
      }

      if (wiki && (wiki.extract || wiki.description)){
        const extract = wiki.extract ? escapeHTML(wiki.extract) : "";
        const desc = wiki.description ? escapeHTML(wiki.description) : "";
        const page = wiki.content_urls && wiki.content_urls.desktop && wiki.content_urls.desktop.page ? wiki.content_urls.desktop.page : null;

        cards.push(`
          <div class="card">
            <h3>Overview</h3>
            ${desc ? `<p class="note" style="margin:0 0 10px 0;">${desc}</p>` : ""}
            <p class="note" style="margin:0;">${extract || "‚Äî"}</p>
            ${page ? `<p style="margin:10px 0 0 0;"><a class="link" href="${page}" target="_blank" rel="noopener noreferrer">Open source</a></p>` : ""}
          </div>
        `);
      } else {
        cards.push(`
          <div class="card">
            <h3>Overview</h3>
            <p class="note" style="margin:0;">Could not load external summary right now.</p>
          </div>
        `);
      }

      drawerBody.innerHTML = cards.join("");
    }

    function currentFilter(){
      return el("filter") ? el("filter").value : "all";
    }

    function matchesFilter(status){
      const f = currentFilter();
      if (f === "all") return true;
      return status === f;
    }

    function styleFeature(feature){
      const name = canonicalName(feature.properties?.name || "");
      const s = statusOf(name);
      const color = statusColor(s);

      let fillOpacity = 0.40;
      if (s === "member" || s === "founding") fillOpacity = 0.55;
      if (s === "observer") fillOpacity = 0.45;
      if (s === "invite") fillOpacity = 0.45;
      if (s === "conflict") fillOpacity = 0.50;

      let opacity = 0.60;
      let weight = 1;

      const match = matchesFilter(s);
      if (!match){
        fillOpacity = Math.min(fillOpacity, 0.12);
        opacity = 0.15;
      }

      if (memberFocus && selectedName){
        const selStatus = statusOf(selectedName);
        const selectedIsMember = (selStatus === "member" || selStatus === "founding");
        if (selectedIsMember){
          const thisIsMember = (s === "member" || s === "founding");
          if (!thisIsMember){
            fillOpacity = Math.min(fillOpacity, 0.08);
            opacity = Math.min(opacity, 0.12);
            weight = 1;
          } else {
            fillOpacity = Math.max(fillOpacity, 0.58);
            opacity = Math.max(opacity, 0.75);
            weight = 1.2;
          }
        }
      }

      return {
        color: "rgba(15,27,58,.18)",
        weight,
        fillColor: color,
        fillOpacity,
        opacity
      };
    }

    function setFeatureHover(layer, on){
      if (!layer || !layer.feature) return;
      if (selectedFeature === layer) return;

      if (on){
        layer.setStyle({
          weight: 2,
          color: "rgba(27,63,191,.35)",
          fillOpacity: Math.min(0.72, (statusOf(layer.feature.properties?.name || "") === "member") ? 0.66 : 0.58)
        });
      } else {
        layer.setStyle(styleFeature(layer.feature));
      }
    }

    function refreshStyles(){
      if (!countriesLayer) return;
      countriesLayer.eachLayer((layer) => {
        layer.setStyle(styleFeature(layer.feature));
      });
      if (selectedFeature){
        selectedFeature.setStyle({
          weight: 2.5,
          color: "rgba(27,63,191,.55)",
          fillOpacity: 0.78,
          opacity: 0.9
        });
      }
    }

    function selectLayer(layer){
      if (!layer || !layer.feature) return;

      if (selectedFeature && selectedFeature !== layer){
        selectedFeature.setStyle(styleFeature(selectedFeature.feature));
      }
      selectedFeature = layer;

      const name = canonicalName(layer.feature.properties?.name || "");
      selectedName = name;

      layer.setStyle({
        weight: 2.5,
        color: "rgba(27,63,191,.55)",
        fillOpacity: 0.78,
        opacity: 0.9
      });

      setStatusLine(name);
      openDrawer();

      const badges = situationBadges(name);
      const popupHtml = `<b>${escapeHTML(name)}</b><div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">${badges}</div>`;
      layer.bindPopup(popupHtml).openPopup();

      fillDrawerFromInternet(name).catch(() => {
        setDrawerHeader(name);
        drawerBody.innerHTML = `<div class="card"><h3>Overview</h3><p class="note" style="margin:0;">Could not load summary right now.</p></div>`;
      });

      refreshStyles();
      refreshLinks();
    }

    // Selecting a fictional nation (no map feature)
    function selectFictional(name){
      const n = canonicalName(name);

      // clear map selection highlight
      if (selectedFeature){
        selectedFeature.setStyle(styleFeature(selectedFeature.feature));
      }
      selectedFeature = null;
      selectedName = n;

      setStatusLine(n);
      openDrawer();

      if (map) map.closePopup();

      // Fill drawer locally (no fetch)
      fillDrawerFictional(n);

      // Keep styles/links coherent with focus mode
      refreshStyles();
      refreshLinks();
    }

    function zoomToSelected(){
      if (!selectedFeature) return;
      try{ map.fitBounds(selectedFeature.getBounds().pad(0.25)); }catch(_){}
    }

    function findCountryLayerByName(query){
      const q = normalize(canonicalName(query));
      if (!q || !countriesLayer) return null;

      let exact = null;
      countriesLayer.eachLayer((layer) => {
        const name = normalize(canonicalName(layer.feature.properties?.name || ""));
        if (name === q) exact = layer;
      });
      if (exact) return exact;

      let partial = null;
      countriesLayer.eachLayer((layer) => {
        const name = normalize(canonicalName(layer.feature.properties?.name || ""));
        if (!partial && name.includes(q)) partial = layer;
      });
      return partial;
    }

    function centroidOfLayer(layer){
      const b = layer.getBounds();
      const c = b.getCenter();
      return [c.lat, c.lng];
    }

    function memberCentroids(){
      const out = [];
      if (!countriesLayer) return out;

      countriesLayer.eachLayer((layer) => {
        const nm = canonicalName(layer.feature?.properties?.name || "");
        const st = statusOf(nm);
        if (st === "member" || st === "founding"){
          out.push({ name: nm, latlng: centroidOfLayer(layer) });
        }
      });

      return out;
    }

    function linkStyle(kind){
      const night = document.documentElement.getAttribute("data-theme") === "night";

      if (kind === "diplomatic"){
        return {
          color: night ? "rgba(160,200,255,.45)" : "rgba(27,63,191,.45)",
          weight: 2,
          opacity: 0.75,
          dashArray: "6 10"
        };
      }
      if (kind === "trade"){
        return {
          color: night ? "rgba(120,255,220,.38)" : "rgba(24,169,153,.45)",
          weight: 2,
          opacity: 0.70,
          dashArray: "2 10"
        };
      }
      return {
        color: night ? "rgba(255,210,120,.42)" : "rgba(255,204,51,.55)",
        weight: 2.4,
        opacity: 0.75
      };
    }

    function buildLinks(kind){
      if (!map) return;

      if (linksLayer){
        linksLayer.remove();
        linksLayer = null;
      }
      if (kind === "off") return;

      const nodes = memberCentroids();
      if (nodes.length < 2) return;

      const groups = [];
      const add = (a, b, k) => groups.push({ a, b, k });

      for (let i = 0; i < nodes.length; i++){
        for (let j = i + 1; j < nodes.length; j++){
          if ((i + j) % 3 !== 0) continue;
          if (kind === "all"){
            add(nodes[i], nodes[j], "diplomatic");
            if ((i + j) % 2 === 0) add(nodes[i], nodes[j], "trade");
            if ((i + j) % 4 === 0) add(nodes[i], nodes[j], "political");
          } else {
            add(nodes[i], nodes[j], kind);
          }
        }
      }

      linksLayer = L.layerGroup();
      for (const g of groups){
        const line = L.polyline([g.a.latlng, g.b.latlng], linkStyle(g.k));
        line.addTo(linksLayer);
      }
      linksLayer.addTo(map);
    }

    function refreshLinks(){
      const sel = el("links");
      if (!sel) return;
      buildLinks(sel.value);
    }

    function iso2FromName(name){
      const n = canonicalName(name);
      const mapIso = new Map([
        ["Luxembourg","LU"],
        ["Falkland Islands","FK"],
        ["Israel","IL"],
        ["United States of America","US"],
        ["Philippines","PH"],
        ["Brazil","BR"]
      ]);
      return mapIso.get(n) || null;
    }

    function twemojiFlagUrlFromISO2(iso2){
      const A = "A".codePointAt(0);
      const cps = iso2.toUpperCase().split("").map(ch => (0x1F1E6 + (ch.codePointAt(0) - A)).toString(16));
      return `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/${cps.join("-")}.png`;
    }

    function loadImage(url){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    function drawStar(ctx, cx, cy, spikes, outerR, innerR){
      let rot = Math.PI / 2 * 3;
      const step = Math.PI / spikes;

      ctx.beginPath();
      ctx.moveTo(cx, cy - outerR);
      for (let i = 0; i < spikes; i++){
        ctx.lineTo(cx + Math.cos(rot) * outerR, cy + Math.sin(rot) * outerR);
        rot += step;
        ctx.lineTo(cx + Math.cos(rot) * innerR, cy + Math.sin(rot) * innerR);
        rot += step;
      }
      ctx.closePath();
    }

    async function runIntroAnimation(){
      const intro = el("intro");
      const canvas = el("introCanvas");
      const ctx = canvas.getContext("2d", { alpha: true });
      if (!ctx){
        finishIntro();
        return;
      }

      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        canvas.width = Math.floor(canvas.clientWidth * dpr);
        canvas.height = Math.floor(canvas.clientHeight * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize, { passive:true });

      const members = Array.from(OFN.members);
      const nodes = [];
      for (const name of members){
        const iso2 = iso2FromName(name);
        let img = null;
        if (iso2){
          try{ img = await loadImage(twemojiFlagUrlFromISO2(iso2)); } catch(_){ img = null; }
        }
        nodes.push({ name, iso2, img, phase: Math.random()*Math.PI*2 });
      }

      const orbitSeconds = 2.0;
      const flySeconds = 0.7;
      const fadeInSeconds = 0.55;
      const total = orbitSeconds + flySeconds + fadeInSeconds;

      let t0 = performance.now();

      function tick(now){
        const t = (now - t0)/1000;
        const w = canvas.clientWidth;
        const h = canvas.clientHeight;

        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0,w,h);

        const cx = w*0.5, cy = h*0.5;
        const R = Math.min(w,h)*0.26;

        const orbitT = Math.min(1, t / orbitSeconds);
        const flyT = Math.max(0, Math.min(1, (t - orbitSeconds)/flySeconds));
        const fadeT = Math.max(0, Math.min(1, (t - orbitSeconds - flySeconds)/fadeInSeconds));

        ctx.strokeStyle = "rgba(27,63,191,.16)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(cx, cy, R, 0, Math.PI*2);
        ctx.stroke();

        const pulse = 0.5 + 0.5*Math.sin(t*2.2);
        ctx.fillStyle = `rgba(255,204,51,${0.18 + 0.10*pulse})`;
        ctx.beginPath();
        ctx.arc(cx, cy, 4 + 2*pulse, 0, Math.PI*2);
        ctx.fill();

        const n = Math.max(1, nodes.length);
        const spin = t * 0.9;

        for (let i=0;i<nodes.length;i++){
          const node = nodes[i];
          const a = (i/n)*Math.PI*2 + spin;
          const wob = 1 + 0.02*Math.sin(t*2.8 + node.phase);
          let rr = R * wob;

          let x = cx + Math.cos(a)*rr;
          let y = cy + Math.sin(a)*rr;

          let alpha = Math.min(1, 0.10 + orbitT*0.90);

          if (flyT > 0){
            const dir = (i % 2 === 0) ? 1 : -1;
            x += dir * flyT * (w*0.58);
            y += (Math.sin(a)*flyT) * (h*0.10);
            alpha *= (1 - flyT);
          }

          ctx.save();

          ctx.globalAlpha = 0.70 * alpha;
          ctx.fillStyle = "rgba(255,204,51,.22)";
          drawStar(ctx, x, y, 5, 18, 8);
          ctx.fill();

          ctx.globalAlpha = 0.45 * alpha;
          ctx.strokeStyle = "rgba(27,63,191,.14)";
          ctx.lineWidth = 1;
          drawStar(ctx, x, y, 5, 18, 8);
          ctx.stroke();

          ctx.globalAlpha = 1.0 * alpha;
          if (node.img){
            const size = 22;
            ctx.drawImage(node.img, x - size/2, y - size/2, size, size);
          } else {
            ctx.fillStyle = "rgba(15,27,58,.92)";
            ctx.font = "14px system-ui";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText((node.iso2 || node.name.slice(0,2).toUpperCase()), x, y);
          }

          ctx.restore();
        }

        topbar.classList.toggle("ready", fadeT > 0.05);
        statusline.classList.toggle("ready", fadeT > 0.20);

        if (t < total){
          requestAnimationFrame(tick);
        } else {
          finishIntro();
        }
      }

      requestAnimationFrame(tick);

      function finishIntro(){
        intro.classList.add("hidden");
        setTimeout(() => intro.remove(), 600);
        topbar.classList.add("ready");
        statusline.classList.add("ready");
      }
    }

    function initMap(){
      map = L.map("map", {
        zoomControl: false,
        worldCopyJump: true,
        preferCanvas: true,
        minZoom: 2,
        maxZoom: 7,
        maxBounds: L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180)),
        maxBoundsViscosity: 1.0
      }).setView([22, 0], 2);

      L.control.zoom({ position: "bottomright" }).addTo(map);

      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        subdomains: "abcd",
        maxZoom: 7,
        minZoom: 2,
        attribution: "&copy; OpenStreetMap contributors &copy; CARTO"
      }).addTo(map);

      const geoUrl = "https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson";

      fetch(geoUrl)
        .then(r => r.json())
        .then(geo => {
          countriesLayer = L.geoJSON(geo, {
            style: styleFeature,
            onEachFeature: (feature, layer) => {
              layer.on("mouseover", () => setFeatureHover(layer, true));
              layer.on("mouseout", () => setFeatureHover(layer, false));
              layer.on("click", () => selectLayer(layer));
            }
          }).addTo(map);

          const bounds = countriesLayer.getBounds();
          if (bounds && bounds.isValid()) map.fitBounds(bounds.pad(0.02));

          wireUI();
          wireFictionPanel();
          applyTheme("auto");
          startThemeClock();
          buildLinks("off");
          runIntroAnimation();
        })
        .catch(() => {
          wireUI();
          wireFictionPanel();
          applyTheme("auto");
          startThemeClock();
          runIntroAnimation();
        });
    }

    function wireFictionPanel(){
      const panel = el("fictionPanel");
      const toggle = el("fictionToggle");
      const list = el("fictionList");

      // populate list
      const items = Array.from(FICTIONAL.entries()).map(([name, data]) => ({ name, ...data }));
      // stable sort: members first, invites next, neutrals last (feel free to change)
      const order = { founding:0, member:1, observer:2, invite:3, neutral:4, conflict:5 };
      items.sort((a,b) => (order[a.status] ?? 9) - (order[b.status] ?? 9) || a.name.localeCompare(b.name));

      const miniClass = (s) => (s === "member" ? "member" : (s === "invite" ? "invite" : "neutral"));

      list.innerHTML = items.map(it => `
        <div class="fictionItem" role="button" tabindex="0" data-name="${escapeHTML(it.name)}" title="Open ${escapeHTML(it.name)}">
          <div class="left">
            <div class="name">${escapeHTML(it.name)}</div>
            <div class="sub">${escapeHTML(statusLabel(it.status))}</div>
          </div>
          <div class="right">
            <div class="miniBadge ${miniClass(it.status)}">${escapeHTML(statusLabel(it.status))}</div>
          </div>
        </div>
      `).join("");

      function setOpen(open){
        panel.classList.toggle("closed", !open);
        syncFictionToggleIcon();
      }

      toggle.addEventListener("click", () => setOpen(panel.classList.contains("closed")));

      // click/keyboard activation
      list.addEventListener("click", (e) => {
        const item = e.target.closest(".fictionItem");
        if (!item) return;
        const name = item.getAttribute("data-name");
        if (!name) return;
        // unescape HTML entities in attribute? (we stored escaped)
        // safest: map by normalize check
        const match = Array.from(FICTIONAL.keys()).find(k => k === name) || Array.from(FICTIONAL.keys()).find(k => escapeHTML(k) === name) || name;
        selectFictional(match);
      });

      list.addEventListener("keydown", (e) => {
        if (e.key !== "Enter" && e.key !== " ") return;
        const item = e.target.closest(".fictionItem");
        if (!item) return;
        e.preventDefault();
        const name = item.getAttribute("data-name");
        const match = Array.from(FICTIONAL.keys()).find(k => k === name) || Array.from(FICTIONAL.keys()).find(k => escapeHTML(k) === name) || name;
        selectFictional(match);
      });

      // default to open after intro feels alive; but keep closed by default if you prefer
      setOpen(false);
    }

    function syncFictionToggleIcon(){
      const panel = el("fictionPanel");
      const toggle = el("fictionToggle");
      if (!panel || !toggle) return;

      // if closed, arrow points left (inviting you to pull it out)
      // if open, arrow points right (to tuck it away)
      const isClosed = panel.classList.contains("closed");
      toggle.textContent = isClosed ? "‚óÄ" : "‚ñ∂";
      toggle.title = isClosed ? "Show fictional nations" : "Hide fictional nations";
    }

    function wireUI(){
      el("closeBtn").addEventListener("click", closeDrawer);

      // Disable zoom button for fictional selection (no map bounds to zoom to)
      el("zoomBtn").addEventListener("click", () => {
        if (selectedFeature) zoomToSelected();
      });

      el("fitBtn").addEventListener("click", () => {
        if (countriesLayer){
          const b = countriesLayer.getBounds();
          if (b && b.isValid()) map.fitBounds(b.pad(0.02));
        } else {
          map.setView([22,0], 2);
        }
      });

      el("resetBtn").addEventListener("click", () => {
        el("search").value = "";
        el("filter").value = "all";
        el("links").value = "off";
        el("theme").value = "auto";
        memberFocus = false;
        el("focusBtn").textContent = "Member focus: Off";
        closeDrawer();
        selectedName = null;

        if (selectedFeature){
          selectedFeature.setStyle(styleFeature(selectedFeature.feature));
        }
        selectedFeature = null;

        setStatusLine(null);
        refreshStyles();
        refreshLinks();
        applyTheme("auto");
        if (map) map.closePopup();
      });

      el("filter").addEventListener("change", () => {
        refreshStyles();
      });

      el("theme").addEventListener("change", (e) => {
        applyTheme(e.target.value);
      });

      el("links").addEventListener("change", () => {
        buildLinks(el("links").value);
      });

      el("focusBtn").addEventListener("click", () => {
        memberFocus = !memberFocus;
        el("focusBtn").textContent = `Member focus: ${memberFocus ? "On" : "Off"}`;
        refreshStyles();
      });

      const searchEl = el("search");
      const doSearch = () => {
        const q = searchEl.value.trim();
        if (!q) return;

        // if it matches a fictional nation, open that
        const qCan = canonicalName(q);
        if (FICTIONAL.has(qCan)){
          selectFictional(qCan);
          return;
        }

        // otherwise search real map countries
        const layer = findCountryLayerByName(q);
        if (layer){
          selectLayer(layer);
          try{ map.fitBounds(layer.getBounds().pad(0.25)); }catch(_){}
        }
      };
      searchEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch();
      });

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeDrawer();
      });

      document.addEventListener("click", (e) => {
        if (!drawer.classList.contains("open")) return;
        const withinDrawer = drawer.contains(e.target);
        const withinTopbar = topbar.contains(e.target);
        const cls = String(e.target.className || "");
        const isLeaflet = cls.includes("leaflet");
        if (!withinDrawer && !withinTopbar && !isLeaflet){
          // leaving open feels more ‚Äúdashboard‚Äù
        }
      }, { capture:true });
    }

    setStatusLine(null);
    initMap();
  </script>
</body>
</html>
